import { useState, useEffect, type FC } from 'react';
import { Play, Star, Trophy, BookOpen, Lock, CheckCircle, TrendingUp, Award, Shield } from 'lucide-react';
import LoadingVideo from './LoadingVideo';
import Toast from './Toast';
import { fetchChapters, fetchSections } from '../services/courseService.js'
import { getChapterProgressPercent } from '../services/progressService'
import { isAdmin } from '../utils/adminUtils.js'
import { supabase } from '../services/supabaseClient.js'

interface Chapter {
  id: number;
  title: string;
  description: string;
  progress: number;
  badge: string;
  isCompleted: boolean;
  isStarted: boolean;
  isLocked: boolean;
  estimatedTime: string;
  difficulty: '–õ–µ–≥–∫–∏–π' | '–°—Ä–µ–¥–Ω–∏–π' | '–°–ª–æ–∂–Ω—ã–π';
  sectionsCount: number;
  studentsCount: number;
  rating: number;
  prerequisites?: number[];
}

interface Section {
  id: number;
  title: string;
}

interface ChaptersListProps {
  onChapterSelect: (chapterId: number) => void;
  currentUser?: string | null | undefined;
}

const ChaptersList: FC<ChaptersListProps> = ({ onChapterSelect, currentUser = '' }) => {
  const [selectedDifficulty, setSelectedDifficulty] = useState<string>('all');
  const [showOnlyAvailable, setShowOnlyAvailable] = useState(false);

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
  const hasAdminAccess = () => {
    return isAdmin(currentUser);
  };

  const [chapters, setChapters] = useState<Chapter[]>([])
  const [loading, setLoading] = useState(true)
  const [error, setError] = useState<string | null>(null)
  const [chapterProgress, setChapterProgress] = useState<Record<number, { completed: boolean; average_accuracy: number }>>({})
  const [toastMessage, setToastMessage] = useState<string | null>(null)
  const [openChapterId, setOpenChapterId] = useState<number | null>(null)
  const [sectionsByChapter, setSectionsByChapter] = useState<Record<number, Section[]>>({})

  useEffect(() => {
    const load = async () => {
      try {
        const data = await fetchChapters()
        const processed: Chapter[] = []

        for (const ch of data as Array<{ id: number; title: string }>) {
          const progress = await getChapterProgressPercent(ch.id)

          processed.push({
            id: ch.id,
            title: ch.title || '–ù–µ—Ç –Ω–∞–∑–≤–∞–Ω–∏—è',
            description: '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö',
            progress,
            badge: '–ù–æ–≤–∏—á–æ–∫',
            isCompleted: progress === 100,
            isStarted: progress > 0,
            isLocked: false,
            estimatedTime: '',
            difficulty: '–õ–µ–≥–∫–∏–π',
            sectionsCount: 0,
            studentsCount: 0,
            rating: 0
          })
        }

        setChapters(processed)
      } catch (err) {
        const message = err instanceof Error ? err.message : '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏'
        setError(message)
      } finally {
        setLoading(false)
      }
    }
    load()
  }, [])

  useEffect(() => {
    const loadProgress = async () => {
      const user_id = localStorage.getItem('user_id')
      if (!user_id) return
      const { data } = await supabase
        .from('user_chapter_progress')
        .select('chapter_id, completed, average_accuracy')
        .eq('user_id', user_id)

      if (data) {
        const map: Record<number, { completed: boolean; average_accuracy: number }> = {}
        data.forEach((row: any) => {
          map[row.chapter_id] = {
            completed: row.completed,
            average_accuracy: row.average_accuracy
          }
        })
        setChapterProgress(map)
      }
    }

    loadProgress()
  }, [])

  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –≥–ª–∞–≤—ã
  useEffect(() => {
    if (!chapters.length) return
    for (const ch of chapters) {
      if (chapterProgress[ch.id]?.completed) {
        const key = `chapter_reward_${ch.id}`
        if (!localStorage.getItem(key)) {
          setToastMessage(`–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í—ã –∑–∞–≤–µ—Ä—à–∏–ª–∏ –≥–ª–∞–≤—É ${ch.title}`)
          localStorage.setItem(key, 'true')
          break
        }
      }
    }
  }, [chapterProgress, chapters])


  const getBadgeIcon = (badge: string) => {
    switch (badge) {
      case '–ú–∞—Å—Ç–µ—Ä': return <Trophy className="w-4 h-4" />;
      case '–≠–∫—Å–ø–µ—Ä—Ç': return <Star className="w-4 h-4" />;
      case '–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π': return <CheckCircle className="w-4 h-4" />;
      default: return <BookOpen className="w-4 h-4" />;
    }
  };

  const getBadgeColor = (badge: string) => {
    switch (badge) {
      case '–ú–∞—Å—Ç–µ—Ä': return 'bg-emerald-600 text-white';
      case '–≠–∫—Å–ø–µ—Ä—Ç': return 'bg-green-600 text-white';
      case '–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π': return 'bg-emerald-500 text-white';
      case '–£—á–µ–Ω–∏–∫': return 'bg-green-500 text-white';
      case '–ù–∞—á–∏–Ω–∞—é—â–∏–π': return 'bg-emerald-400 text-emerald-900';
      default: return 'bg-emerald-300 text-emerald-800';
    }
  };

  const getOverallProgress = () => {
    if (chapters.length === 0) return 0
    const completedChapters = chapters.filter(ch => ch.isCompleted).length
    return Math.round((completedChapters / chapters.length) * 100)
  };

  const getNextRecommendedChapter = () => {
    return chapters.find(ch => !ch.isLocked && !ch.isCompleted);
  };

  const filteredChapters = chapters.filter(chapter => {
    if (showOnlyAvailable && chapter.isLocked) return false;
    if (selectedDifficulty !== 'all' && chapter.difficulty !== selectedDifficulty) return false;
    return true;
  });

  const recommendedChapter = getNextRecommendedChapter();

  const handleToggleChapter = async (chapter: Chapter) => {
    if (chapter.isLocked && !hasAdminAccess()) return;
    const chapterId = chapter.id;
    if (openChapterId === chapterId) {
      setOpenChapterId(null);
      return;
    }
    if (!sectionsByChapter[chapterId]) {
      try {
        const data = await fetchSections(chapterId);
        setSectionsByChapter(prev => ({ ...prev, [chapterId]: data as Section[] }));
      } catch (err) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–∞–∑–¥–µ–ª–æ–≤:', err);
      }
    }
    setOpenChapterId(chapterId);
  };

  if (loading) {
    return <LoadingVideo />;
  }

  if (error) {
    return <div className="p-6 text-red-600">{error}</div>
  }

  return (
    <div className="p-6 pt-2 space-y-6 mx-auto max-w-screen-sm">
      {/* Header */}
      <div className="text-center mb-8">
        <h1 className="text-3xl font-bold text-emerald-900 mb-2">–ò–∑—É—á–µ–Ω–∏–µ —ç—Å–ø–µ—Ä–∞–Ω—Ç–æ</h1>
        <p className="text-emerald-700 mb-4">–ü–æ–ª–Ω—ã–π –∫—É—Ä—Å –∏–∑—É—á–µ–Ω–∏—è –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω–æ–≥–æ —è–∑—ã–∫–∞ —ç—Å–ø–µ—Ä–∞–Ω—Ç–æ</p>
        
        {/* Admin Access Indicator */}
        {hasAdminAccess() && (
          <div className="bg-gradient-to-r from-emerald-600 to-green-600 text-white px-6 py-3 rounded-xl mb-6 shadow-lg">
            <div className="flex items-center justify-center space-x-2">
              <Shield className="w-5 h-5" />
              <span className="font-semibold">üëë –†–µ–∂–∏–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞: –î–æ—Å—Ç—É–ø –∫–æ –≤—Å–µ–º –≥–ª–∞–≤–∞–º</span>
            </div>
            <p className="text-emerald-100 text-sm mt-1">
              –£ –≤–∞—Å –µ—Å—Ç—å –ø–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫–æ –≤—Å–µ–º –≥–ª–∞–≤–∞–º –∫—É—Ä—Å–∞ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            </p>
          </div>
        )}
        
      </div>

      <div className="grid grid-cols-1 gap-6">
        {/* Overall Progress */}
        <div className="bg-white rounded-xl shadow-sm border border-emerald-200 p-6">
          <div className="flex items-center justify-between mb-4">
            <h2 className="text-lg font-semibold text-emerald-900">–û–±—â–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å</h2>
            <span className="text-2xl font-bold text-emerald-600">{getOverallProgress()}%</span>
          </div>
          <div className="w-full bg-emerald-200 rounded-full h-3 mb-2">
            <div
              className="bg-gradient-to-r from-emerald-500 to-green-600 h-3 rounded-full transition-all duration-500"
              style={{ width: `${getOverallProgress()}%` }}
            ></div>
          </div>
          <p className="text-sm text-emerald-700">
            {chapters.filter(ch => ch.isCompleted).length} –∏–∑ {chapters.length} –≥–ª–∞–≤ –ø—Ä–æ–π–¥–µ–Ω–æ
            {hasAdminAccess() && (
              <span className="ml-2 text-emerald-600 font-medium">
                (–ê–¥–º–∏–Ω: {chapters.filter(ch => !ch.isLocked).length} –¥–æ—Å—Ç—É–ø–Ω–æ)
              </span>
            )}
          </p>
        </div>

      {/* Recommended Chapter */}
      {recommendedChapter && (
        <div className="bg-white rounded-xl shadow-sm border border-emerald-200 p-6 flex flex-col items-center text-center gap-4">
          <div className="flex flex-wrap items-center gap-2">
            <TrendingUp className="w-5 h-5 text-emerald-600" />
            <h3 className="text-lg font-semibold text-emerald-900">–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∏–∑—É—á–∏—Ç—å</h3>
          </div>
          <div>
            <h4
              className="font-semibold text-emerald-900 break-words"
              style={{ textWrap: 'balance' }}
            >
              {recommendedChapter.title}
            </h4>
            <p className="text-sm text-emerald-700 break-words">{recommendedChapter.description}</p>
          </div>
          <button
            onClick={() => onChapterSelect(recommendedChapter.id)}
            className="w-full py-2 px-4 rounded-lg flex items-center justify-center gap-2 bg-green-600 text-white font-semibold shadow-sm hover:bg-green-700 hover:scale-105 hover:shadow-md transition-transform duration-200 active:scale-100 box-border"
          >
            <Play className="w-4 h-4" />
            <span>–ù–∞—á–∞—Ç—å</span>
          </button>
        </div>
      )}

      {/* Filters */}
      <div className="bg-white rounded-xl shadow-sm border border-emerald-200 p-6">
        <div className="flex flex-wrap gap-4 items-center">
          <div className="flex items-center space-x-2">
            <span className="text-sm font-medium text-emerald-800">–°–ª–æ–∂–Ω–æ—Å—Ç—å:</span>
            <select
              value={selectedDifficulty}
              onChange={(e) => setSelectedDifficulty(e.target.value)}
              className="border border-emerald-300 rounded-lg px-3 py-1 text-sm focus:outline-none focus:border-emerald-500 text-emerald-800"
            >
              <option value="all">–í—Å–µ</option>
              <option value="–õ–µ–≥–∫–∏–π">–õ–µ–≥–∫–∏–π</option>
              <option value="–°—Ä–µ–¥–Ω–∏–π">–°—Ä–µ–¥–Ω–∏–π</option>
              <option value="–°–ª–æ–∂–Ω—ã–π">–°–ª–æ–∂–Ω—ã–π</option>
            </select>
          </div>
          
          {!hasAdminAccess() && (
            <label className="flex items-center space-x-2">
              <input
                type="checkbox"
                checked={showOnlyAvailable}
                onChange={(e) => setShowOnlyAvailable(e.target.checked)}
                className="rounded border-emerald-300 text-emerald-600 focus:ring-emerald-500"
              />
              <span className="text-sm text-emerald-800">–¢–æ–ª—å–∫–æ –¥–æ—Å—Ç—É–ø–Ω—ã–µ</span>
            </label>
          )}
          
          {hasAdminAccess() && (
            <div className="flex items-center space-x-2 bg-emerald-100 px-3 py-1 rounded-full">
              <Shield className="w-4 h-4 text-emerald-600" />
              <span className="text-sm text-emerald-800 font-medium">–ê–¥–º–∏–Ω: –í—Å–µ –≥–ª–∞–≤—ã —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã</span>
            </div>
          )}
        </div>
      </div>

      {/* Chapters Grid */}
      <div className="grid gap-6">
        {filteredChapters.map((chapter) => (
          <div key={chapter.id} className="w-full max-w-sm mx-auto px-4">
            <div
              onClick={() => handleToggleChapter(chapter)}
              className={`rounded-2xl bg-white shadow p-4 text-center space-y-2 cursor-pointer ${
                chapter.isLocked && !hasAdminAccess() ? 'opacity-60' : ''
              }`}
            >
              <div
                className={`w-12 h-12 mx-auto rounded-full flex items-center justify-center text-white font-bold text-lg ${
                  chapter.isLocked && !hasAdminAccess() ? 'bg-gray-400' : 'bg-emerald-600'
                }`}
              >
                {chapter.isLocked && !hasAdminAccess() ? <Lock className="w-6 h-6" /> : chapter.id}
              </div>

              <h3 className="text-lg font-semibold text-emerald-900 break-words" style={{ textWrap: 'balance' }}>
                {chapter.title}
              </h3>

              <div className={`inline-flex items-center space-x-1 px-2 py-1 rounded-full text-xs font-medium ${getBadgeColor(chapter.badge)}`}>
                {getBadgeIcon(chapter.badge)}
                <span>{chapter.badge}</span>
              </div>

              <button
                onClick={(e) => {
                  e.stopPropagation();
                  onChapterSelect(chapter.id);
                }}
                disabled={chapter.isLocked && !hasAdminAccess()}
                className={`w-full py-2 px-4 rounded-lg flex items-center justify-center gap-2 font-semibold transition-transform duration-200 box-border ${
                  chapter.isLocked && !hasAdminAccess()
                    ? 'bg-gray-300 text-gray-500 cursor-not-allowed'
                    : 'bg-green-600 text-white shadow hover:bg-green-700 hover:scale-105 active:scale-100'
                } ${hasAdminAccess() && chapter.isLocked ? 'border-2 border-emerald-400' : ''}`}
              >
                {chapter.isLocked && !hasAdminAccess() ? (
                  <>
                    <Lock className="w-5 h-5" />
                    <span>–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ</span>
                  </>
                ) : hasAdminAccess() && chapter.isLocked ? (
                  <>
                    <Shield className="w-5 h-5" />
                    <span>–û—Ç–∫—Ä—ã—Ç—å (–ê–¥–º–∏–Ω)</span>
                  </>
                ) : (
                  <>
                    <Play className="w-5 h-5" />
                    <span>{chapter.isStarted ? '–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å' : '–ù–∞—á–∞—Ç—å'}</span>
                  </>
                )}
              </button>

              {openChapterId === chapter.id && (
                <ul className="mt-4 space-y-2 text-left">
                  {sectionsByChapter[chapter.id]?.map((section) => (
                    <li
                      key={section.id}
                      className="max-w-[90%] ml-4 border-l-4 border-green-400 rounded-lg bg-gray-50 shadow-sm px-3 py-2 text-sm text-emerald-800"
                    >
                      {section.title}
                    </li>
                  ))}
                </ul>
              )}
            </div>
          </div>
        ))}
      </div>

      {/* Learning Tips */}
      <div className="bg-gradient-to-r from-emerald-50 to-green-50 border border-emerald-200 rounded-xl p-6">
        <div className="flex items-center space-x-2 mb-3">
          <Award className="w-5 h-5 text-emerald-600" />
          <h3 className="text-lg font-semibold text-emerald-900">
            {hasAdminAccess() ? '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏' : '–°–æ–≤–µ—Ç—ã –ø–æ –∏–∑—É—á–µ–Ω–∏—é'}
          </h3>
        </div>
        <div className="grid md:grid-cols-2 gap-4 text-sm text-emerald-800">
          {hasAdminAccess() ? (
            <>
              <div className="flex items-start space-x-2">
                <span className="text-emerald-600">üëë</span>
                <span>–£ –≤–∞—Å –µ—Å—Ç—å –¥–æ—Å—Ç—É–ø –∫–æ –≤—Å–µ–º –≥–ª–∞–≤–∞–º –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è</span>
              </div>
              <div className="flex items-start space-x-2">
                <span className="text-emerald-600">üîì</span>
                <span>–í—Å–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ø–æ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–º —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º —Å–Ω—è—Ç—ã</span>
              </div>
              <div className="flex items-start space-x-2">
                <span className="text-emerald-600">‚öôÔ∏è</span>
                <span>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—É—é –ø–∞–Ω–µ–ª—å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–æ–º</span>
              </div>
              <div className="flex items-start space-x-2">
                <span className="text-emerald-600">üìä</span>
                <span>–î–æ—Å—Ç—É–ø–Ω–∞ –ø–æ–ª–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</span>
              </div>
            </>
          ) : (
            <>
              <div className="flex items-start space-x-2">
                <span className="text-emerald-600">‚Ä¢</span>
                <span>–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø—Ä–æ—Ö–æ–¥–∏—Ç—å –≥–ª–∞–≤—ã –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –ª—É—á—à–µ–≥–æ —É—Å–≤–æ–µ–Ω–∏—è –º–∞—Ç–µ—Ä–∏–∞–ª–∞</span>
              </div>
              <div className="flex items-start space-x-2">
                <span className="text-emerald-600">‚Ä¢</span>
                <span>–£–¥–µ–ª—è–π—Ç–µ –∏–∑—É—á–µ–Ω–∏—é 15-30 –º–∏–Ω—É—Ç –≤ –¥–µ–Ω—å –¥–ª—è –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –ª—É—á—à–∏—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤</span>
              </div>
              <div className="flex items-start space-x-2">
                <span className="text-emerald-600">‚Ä¢</span>
                <span>–ò–∑—É—á–∞–π—Ç–µ —Ç–µ–æ—Ä–∏—é –ø–µ—Ä–µ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ–º –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏—Ö –∑–∞–¥–∞–Ω–∏–π</span>
              </div>
              <div className="flex items-start space-x-2">
                <span className="text-emerald-600">‚Ä¢</span>
                <span>–ü—Ä–∞–∫—Ç–∏–∫—É–π—Ç–µ –ø–æ–ª—É—á–µ–Ω–Ω—ã–µ –∑–Ω–∞–Ω–∏—è –≤ —Ä–∞–∑–¥–µ–ª–µ "AI –ü–æ–º–æ—â–Ω–∏–∫"</span>
              </div>
            </>
          )}
        </div>
      </div>
        {toastMessage && (
          <Toast message={toastMessage} onClose={() => setToastMessage(null)} />
        )}
      </div>
    </div>
  );
};

export default ChaptersList;
